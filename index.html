<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–´ë¨¸ë‹ˆ ì§€í•˜ì²  ë„ìš°ë¯¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap');
        
        body {
            font-family: 'Nanum+Gothic', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            font-size: 1.1rem;
        }
        
        .big-button {
            transition: transform 0.1s active;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .big-button:active {
            transform: scale(0.98);
        }

        .line-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 15px;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            margin-right: 4px;
        }

        /* ë…¸ì„ ë³„ ëŒ€í‘œ ìƒ‰ìƒ */
        .line-1 { background-color: #0052A4; } .line-2 { background-color: #009D3E; }
        .line-3 { background-color: #EF7C1C; } .line-4 { background-color: #00A5DE; }
        .line-5 { background-color: #996CAC; } .line-6 { background-color: #CD7C2F; }
        .line-7 { background-color: #747F00; } .line-8 { background-color: #e6186c; }
        .line-9 { background-color: #BDB092; } .line-gj { background-color: #77c4a3; }
        .line-gc { background-color: #0C8E72; } .line-gtx { background-color: #A6142F; }
        .line-suin { background-color: #F5A200; } .line-shin { background-color: #D4003B; }
        .line-default { background-color: #64748b; }

        .path-step {
            position: relative;
            padding-left: 45px;
            padding-bottom: 30px;
        }
        .path-step::before {
            content: '';
            position: absolute;
            left: 17px;
            top: 15px;
            bottom: -5px;
            width: 4px;
            background-color: #e2e8f0;
            border-radius: 2px;
        }
        .path-step:last-child::before { display: none; }
        .circle-num {
            position: absolute;
            left: 0;
            top: 0;
            width: 36px;
            height: 36px;
            background-color: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1rem;
            z-index: 10;
        }

        .action-text {
            color: #1e293b;
            font-weight: 700;
            font-size: 1.2rem;
            line-height: 1.5;
        }

        .highlight-action {
            color: #dc2626;
            font-weight: 800;
            text-decoration: underline;
        }

        #map-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            overflow: auto;
        }

        #station-input { font-size: 1.5rem; }

        /* ë©”ì‹œì§€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        #message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            width: 85%;
            max-width: 350px;
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen bg-gray-50 pb-16">

    <header class="bg-blue-600 text-white p-6 text-center shadow-lg">
        <h1 class="text-2xl font-black mb-1 tracking-tight">ì§€í•˜ì²  ë„ìš°ë¯¸</h1>
        <p class="text-base opacity-90 font-bold">ì–´ë¨¸ë‹ˆ, ì˜¤ëŠ˜ ì–´ë”” ê°€ì‹œë‚˜ìš”?</p>
    </header>

    <main class="p-4 space-y-6">
        <!-- ë©”ì¸ ë©”ë‰´ -->
        <div id="main-menu" class="space-y-4 pt-2">
            <button onclick="openSearch('out')" class="big-button w-full bg-white border-2 border-blue-500 rounded-2xl p-6 text-left flex items-center justify-between shadow-sm">
                <div>
                    <span class="text-gray-500 text-base block mb-1 font-bold">ì§‘ì—ì„œ ë‚˜ê°ˆ ë•Œ</span>
                    <span class="text-2xl font-black text-gray-800">êµ¬ë¦¬ì—­ ì¶œë°œ</span>
                </div>
                <span class="text-5xl">ğŸ </span>
            </button>

            <button onclick="openSearch('in')" class="big-button w-full bg-white border-2 border-green-500 rounded-2xl p-6 text-left flex items-center justify-between shadow-sm">
                <div>
                    <span class="text-gray-500 text-base block mb-1 font-bold">ì§‘ìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œ</span>
                    <span class="text-2xl font-black text-gray-800">êµ¬ë¦¬ì—­ ë„ì°©</span>
                </div>
                <span class="text-5xl">ğŸš‰</span>
            </button>

            <button onclick="toggleMap(true)" class="big-button w-full bg-orange-400 border-2 border-orange-500 rounded-2xl p-4 text-center">
                <span class="text-xl font-black text-white">ğŸ—ºï¸ ë…¸ì„ ë„ í¬ê²Œ ë³´ê¸°</span>
            </button>

            <div id="favorites-section" class="hidden mt-6">
                <h2 class="text-xl font-black text-gray-700 mb-3 ml-1">â­ ìì£¼ ê°€ëŠ” ê³³</h2>
                <div id="favorites-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- ê²€ìƒ‰ì°½ -->
        <div id="search-view" class="hidden fixed inset-0 bg-white z-[60] p-6 flex flex-col">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-black text-blue-800">ì—­ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</h2>
                <button onclick="closeSearch()" class="text-4xl font-bold p-2 text-gray-400">âœ•</button>
            </div>
            
            <input type="text" id="station-input" oninput="filterStations(this.value)" autofocus
                   placeholder="ì˜ˆ: ì„œìš¸ì—­, ê°•ë‚¨, ì ì‹¤" 
                   class="w-full border-b-4 border-blue-500 p-3 font-black focus:outline-none placeholder-gray-300">
            
            <div id="search-results" class="flex-1 overflow-y-auto space-y-3 mt-4 pb-6">
                <!-- ì¶”ì²œ ì—­ ëª©ë¡ì´ ì—¬ê¸°ì— ëœ¹ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ê²½ë¡œ ì•ˆë‚´íŒ -->
        <div id="route-detail" class="hidden bg-white rounded-3xl border-2 border-blue-200 p-6 shadow-xl space-y-6">
            <div class="flex justify-between items-center">
                <button onclick="goHome()" class="bg-gray-400 text-white px-4 py-2 rounded-xl text-lg font-bold">ì²˜ìŒìœ¼ë¡œ</button>
                <button id="fav-btn" onclick="toggleFavorite()" class="text-4xl">â˜†</button>
            </div>
            
            <!-- ì—¬ì • ìš”ì•½ -->
            <div id="route-path-summary" class="flex flex-wrap items-center justify-center gap-1 p-3 bg-gray-50 rounded-2xl border border-gray-100"></div>

            <div id="route-content" class="space-y-4"></div>

            <button onclick="toggleMap(true)" class="block w-full bg-orange-500 text-white text-center py-4 rounded-2xl text-xl font-black shadow-lg">
                ğŸ—ºï¸ ì§€ë„ì—ì„œ í™•ì¸
            </button>
        </div>

        <!-- ë¡œë”© -->
        <div id="loading" class="hidden fixed inset-0 bg-black/40 z-[100] flex items-center justify-center">
            <div class="bg-white p-8 rounded-3xl text-center shadow-2xl">
                <div class="inline-block w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"></div>
                <p class="text-xl font-bold text-gray-800">ê¸¸ì„ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>
    </main>

    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="message-box" class="bg-white p-6 rounded-3xl border-4 border-red-400 shadow-2xl text-center">
        <p id="message-text" class="text-lg font-bold text-gray-800 mb-4"></p>
        <button onclick="hideMessage()" class="bg-gray-500 text-white px-6 py-2 rounded-xl font-bold shadow-md">í™•ì¸</button>
    </div>

    <!-- ì§€ë„ ëª¨ë‹¬ -->
    <div id="map-modal">
        <div class="min-h-screen flex flex-col p-4">
            <button onclick="toggleMap(false)" class="sticky top-4 self-end bg-white border-2 border-black text-black px-6 py-2 rounded-full text-xl font-bold shadow-2xl z-[110]">ë‹«ê¸° âœ•</button>
            <div class="overflow-auto mt-4 flex-1 rounded-2xl bg-white shadow-inner">
                <img src="map_korea.jpg" alt="ë…¸ì„ ë„" class="max-w-none w-[400%]" id="map-img">
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let currentTarget = null;
        let searchMode = 'out';
        
        let favorites = JSON.parse(localStorage.getItem('guri_mama_v15') || '[]');
        let routeCache = JSON.parse(localStorage.getItem('guri_route_cache_v15') || '{}');

        // ì£¼ìš” ì—­ ëª©ë¡ (ì¶”ì²œìš©)
        const commonStations = [
            "ì ì‹¤ì—­", "ì„œìš¸ì—­", "ê°•ë‚¨ì—­", "ì²œí˜¸ì—­", "ë‹¤ì‚°ì—­", "ë³„ë‚´ì—­", "ì™•ì‹­ë¦¬ì—­", "ì²­ëŸ‰ë¦¬ì—­", "ëª…ë™ì—­", 
            "í™ëŒ€ì…êµ¬ì—­", "ê³ ì†í„°ë¯¸ë„ì—­", "ì‹ ë„ë¦¼ì—­", "ë™ëŒ€ë¬¸ì—­", "ê±´ëŒ€ì…êµ¬ì—­", "ê°€ë½ì‹œì¥ì—­", "ë³µì •ì—­", 
            "ì„ì´Œì—­", "ì¢…ë¡œ3ê°€ì—­", "ì„ì§€ë¡œì…êµ¬ì—­", "ì‹ ì´Œì—­", "ìˆ˜ì›ì—­", "ì¸ì²œì—­", "ë™íƒ„ì—­", "íŒêµì—­", "ìƒë´‰ì—­", "ë„ë†ì—­"
        ];

        function formatStationName(name) {
            if (!name) return "";
            return name.trim().replace(/ì—­+$/, '') + 'ì—­';
        }

        function showMessage(text) {
            document.getElementById('message-text').innerText = text;
            document.getElementById('message-box').style.display = 'block';
        }

        function hideMessage() {
            document.getElementById('message-box').style.display = 'none';
        }

        function openSearch(mode) {
            searchMode = mode;
            document.getElementById('search-view').classList.remove('hidden');
            document.getElementById('station-input').value = '';
            document.getElementById('station-input').focus();
            filterStations('');
        }

        function closeSearch() {
            document.getElementById('search-view').classList.add('hidden');
        }

        function filterStations(query) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';
            
            if (query.length > 0) {
                // 1. "ìƒˆë¡œ ì°¾ê¸°" ë²„íŠ¼ (ì…ë ¥í•œ ê°’ ê·¸ëŒ€ë¡œ)
                const mainBtn = document.createElement('button');
                mainBtn.className = "w-full bg-blue-50 border-2 border-blue-300 p-5 rounded-2xl text-left shadow-sm flex justify-between items-center mb-6";
                mainBtn.onclick = () => findRoute(query);
                mainBtn.innerHTML = `<span class="text-xl font-bold text-blue-900">'${formatStationName(query)}' ê¸¸ì°¾ê¸°</span> <span class="text-2xl">ğŸ”</span>`;
                container.appendChild(mainBtn);

                // 2. ì…ë ¥ê°’ ê¸°ë°˜ ì¶”ì²œ ëª©ë¡
                const matches = commonStations.filter(s => s.includes(query) && formatStationName(s) !== formatStationName(query));
                if (matches.length > 0) {
                    const label = document.createElement('p');
                    label.className = "text-sm text-gray-500 mb-2 ml-1 font-bold";
                    label.innerText = "í˜¹ì‹œ ì´ ì—­ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?";
                    container.appendChild(label);

                    matches.forEach(name => {
                        const btn = document.createElement('button');
                        btn.className = "w-full bg-white border-2 border-gray-100 p-4 rounded-xl text-left shadow-sm mb-2 active:bg-gray-50";
                        btn.onclick = () => findRoute(name);
                        btn.innerHTML = `<span class="text-lg font-bold text-gray-800">${name}</span>`;
                        container.appendChild(btn);
                    });
                }
            } else {
                // ê²€ìƒ‰ì–´ê°€ ì—†ì„ ë•Œ ë³´ì—¬ì¤„ ê¸°ë³¸ ëª©ë¡
                const recentLabel = document.createElement('p');
                recentLabel.className = "text-sm text-gray-500 mb-3 ml-1 font-bold";
                recentLabel.innerText = "ê°€ì‹¤ ê³³ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”";
                container.appendChild(recentLabel);

                commonStations.slice(0, 10).forEach(name => {
                    const btn = document.createElement('button');
                    btn.className = "w-full bg-white border-2 border-gray-100 p-4 rounded-xl text-left shadow-sm mb-2 active:bg-gray-50";
                    btn.onclick = () => findRoute(name);
                    btn.innerHTML = `<span class="text-lg font-bold text-gray-800">${name}</span>`;
                    container.appendChild(btn);
                });
            }
        }

        async function fetchRouteWithRetry(start, end, maxRetries = 5) {
            const delays = [1000, 2000, 4000, 8000, 16000];
            const systemPrompt = `ì„œìš¸ ì§€í•˜ì²  ì•ˆë‚´ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 80ëŒ€ ì–´ë¨¸ë‹ˆë¥¼ ìœ„í•´ ì•„ì£¼ ì‰½ê³  ê°„ê²°í•˜ê²Œ ë‹µí•˜ì„¸ìš”.
            ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
            {
                "path": ["ì¶œë°œì—­", "í™˜ìŠ¹ì—­(ìˆëŠ”ê²½ìš°)", "ë„ì°©ì—­"],
                "steps": [
                    {"type": "ride", "station": "ì¶œë°œì—­", "line": "8", "color": "line-8", "msg": "8í˜¸ì„ (ëª¨ë€í–‰) íƒ€ì„¸ìš”."},
                    {"type": "transfer", "station": "í™˜ìŠ¹ì—­", "line": "2", "color": "line-2", "pos": "3-1ë²ˆ", "msg": "ë‚´ë ¤ì„œ 2í˜¸ì„ (êµëŒ€ë°©í–¥)ìœ¼ë¡œ ê°ˆì•„íƒ€ì„¸ìš”."},
                    {"type": "arrive", "station": "ë„ì°©ì—­", "msg": "ë„ì°©í–ˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ ë‚´ë¦¬ì„¸ìš”."}
                ]
            }
            ê·œì¹™: msgì— ì—­ ì´ë¦„ì„ ì¤‘ë³µí•˜ì§€ ë§ˆì„¸ìš”. í–‰ë™ ìœ„ì£¼ë¡œ ì“°ì„¸ìš”.`;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `${start}ì—ì„œ ${end}ê¹Œì§€ ê°€ëŠ” ë²• ì•Œë ¤ì¤˜` }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) throw new Error(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${response.status}`);

                    const result = await response.json();
                    const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!rawText) throw new Error("ì‘ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    
                    const jsonMatch = rawText.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨");
                    
                    return JSON.parse(jsonMatch[0]);
                } catch (err) {
                    if (i === maxRetries - 1) throw err;
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        async function findRoute(targetStation) {
            const formattedTarget = formatStationName(targetStation);
            const cacheKey = `${searchMode}_${formattedTarget}`;
            
            if (routeCache[cacheKey]) {
                closeSearch();
                renderRoute(routeCache[cacheKey], targetStation);
                return;
            }

            closeSearch();
            document.getElementById('loading').classList.remove('hidden');
            
            const start = searchMode === 'out' ? 'êµ¬ë¦¬ì—­' : formattedTarget;
            const end = searchMode === 'out' ? formattedTarget : 'êµ¬ë¦¬ì—­';

            try {
                const route = await fetchRouteWithRetry(start, end);
                routeCache[cacheKey] = route;
                localStorage.setItem('guri_route_cache_v15', JSON.stringify(routeCache));
                renderRoute(route, targetStation);
            } catch (error) {
                console.error("ê¸¸ì°¾ê¸° ì˜¤ë¥˜:", error);
                showMessage("ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì‹œê±°ë‚˜ ì§€ë„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderRoute(route, originalTarget) {
            currentTarget = { name: originalTarget, data: route };
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('route-detail').classList.remove('hidden');

            const summary = document.getElementById('route-path-summary');
            summary.innerHTML = route.path.map((p, idx) => `
                <span class="text-sm font-bold ${idx === route.path.length-1 ? 'text-green-600' : 'text-gray-800'}">${formatStationName(p)}</span>
                ${idx < route.path.length - 1 ? '<span class="text-xs text-gray-300 mx-1">âœ</span>' : ''}
            `).join('');

            const content = document.getElementById('route-content');
            content.innerHTML = route.steps.map((step, idx) => {
                let msgHtml = step.msg;
                if (step.type === 'transfer') {
                    msgHtml = msgHtml.replace("ë‚´ë ¤ì„œ", "<span class='highlight-action'>ë‚´ë ¤ì„œ</span>").replace("ê°ˆì•„íƒ€ì„¸ìš”", "<span class='highlight-action'>ê°ˆì•„íƒ€ì„¸ìš”</span>");
                } else if (step.type === 'arrive' || step.msg.includes("ë‚´ë¦¬ì„¸ìš”")) {
                    msgHtml = msgHtml.replace("ë‚´ë¦¬ì„¸ìš”", "<span class='highlight-action'>ë‚´ë¦¬ì„¸ìš”</span>").replace("ë‚´ë¦¬ì‹œë©´", "<span class='highlight-action'>ë‚´ë¦¬ì‹œë©´</span>");
                }

                return `
                <div class="path-step">
                    <div class="circle-num">${idx + 1}</div>
                    <div class="space-y-1">
                        <div class="flex items-center">
                            <span class="line-badge ${step.color || 'line-default'}">${step.line || ''}</span>
                            <span class="text-lg font-black text-gray-800">${formatStationName(step.station)}</span>
                        </div>
                        <p class="action-text">${msgHtml}</p>
                        ${step.pos ? `
                        <div class="inline-block mt-1 bg-green-50 px-3 py-1 rounded-lg border border-green-200 shadow-sm">
                            <p class="text-sm font-bold text-green-800">ğŸ’¡ ë¹¨ë¦¬ ê°ˆì•„íƒ€ëŠ” ì¹¸: <span class="text-red-600 underline">${step.pos}</span></p>
                        </div>` : ''}
                    </div>
                </div>`;
            }).join('');

            updateFavoriteStar();
        }

        function toggleFavorite() {
            const index = favorites.findIndex(f => f.name === currentTarget.name);
            if (index > -1) favorites.splice(index, 1);
            else favorites.push(currentTarget);
            localStorage.setItem('guri_mama_v15', JSON.stringify(favorites));
            updateFavoriteStar();
        }

        function updateFavoriteStar() {
            const isFav = favorites.some(f => f.name === currentTarget.name);
            const btn = document.getElementById('fav-btn');
            btn.innerText = isFav ? 'â­' : 'â˜†';
            btn.style.color = isFav ? '#f59e0b' : '#9ca3af';
        }

        function renderFavorites() {
            const container = document.getElementById('favorites-list');
            const section = document.getElementById('favorites-section');
            if (favorites.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            container.innerHTML = '';
            favorites.forEach(fav => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-yellow-50 border-2 border-yellow-200 rounded-2xl p-4 flex items-center justify-between shadow-sm active:bg-yellow-100";
                btn.onclick = () => renderRoute(fav.data, fav.name);
                btn.innerHTML = `<span class="text-lg font-bold text-gray-800">ğŸ  â†’ ${formatStationName(fav.name)}</span> <span class="text-xl">â¡ï¸</span>`;
                container.appendChild(btn);
            });
        }

        function goHome() {
            document.getElementById('route-detail').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            renderFavorites();
        }

        function toggleMap(show) { document.getElementById('map-modal').style.display = show ? 'block' : 'none'; }
        window.onload = renderFavorites;
    </script>
</body>
</html>
