<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–´ë¨¸ë‹ˆ ì§€í•˜ì²  ë„ìš°ë¯¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap');
        
        body {
            font-family: 'Nanum+Gothic', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            font-size: 1rem;
        }
        
        .big-button {
            transition: transform 0.1s active;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .big-button:active {
            transform: scale(0.98);
        }

        .line-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
            margin-right: 4px;
        }

        /* ë…¸ì„  ìƒ‰ìƒ */
        .line-1 { background-color: #0052A4; } .line-2 { background-color: #009D3E; }
        .line-3 { background-color: #EF7C1C; } .line-4 { background-color: #00A5DE; }
        .line-5 { background-color: #996CAC; } .line-6 { background-color: #CD7C2F; }
        .line-7 { background-color: #747F00; } .line-8 { background-color: #e6186c; }
        .line-9 { background-color: #BDB092; } .line-gj { background-color: #77c4a3; }
        .line-gc { background-color: #0C8E72; } .line-gtx { background-color: #A6142F; }
        .line-suin { background-color: #F5A200; }
        .line-default { background-color: #64748b; }

        .path-step {
            position: relative;
            padding-left: 40px;
            padding-bottom: 25px;
        }
        .path-step::before {
            content: '';
            position: absolute;
            left: 17px;
            top: 15px;
            bottom: -5px;
            width: 3px;
            background-color: #e2e8f0;
            border-radius: 2px;
        }
        .path-step:last-child::before { display: none; }
        .circle-num {
            position: absolute;
            left: 0;
            top: 0;
            width: 34px;
            height: 34px;
            background-color: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
            z-index: 10;
        }

        .action-text {
            color: #1e293b;
            font-weight: 700;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .highlight-action {
            color: #dc2626;
            font-weight: 800;
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        #map-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            overflow: auto;
        }

        #station-input { font-size: 1.4rem; }
        
        #message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            width: 85%;
            max-width: 350px;
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen bg-gray-50 pb-16">

    <!-- ìƒë‹¨ ë°” -->
    <header class="bg-blue-600 text-white p-5 text-center shadow-lg">
        <h1 class="text-xl font-black mb-1">ì§€í•˜ì²  ë„ìš°ë¯¸</h1>
        <p class="text-sm opacity-90 font-bold">ì–´ë¨¸ë‹ˆ, ì˜¤ëŠ˜ ì–´ë”” ê°€ì‹œë‚˜ìš”?</p>
    </header>

    <main class="p-4 space-y-5">
        <!-- ë©”ì¸ ë©”ë‰´ -->
        <div id="main-menu" class="space-y-4">
            <button onclick="openSearch('out')" class="big-button w-full bg-white border-2 border-blue-500 rounded-2xl p-5 text-left flex items-center justify-between shadow-sm">
                <div>
                    <span class="text-gray-500 text-sm block mb-1 font-bold">ë‚˜ê°ˆ ë•Œ</span>
                    <span class="text-xl font-black text-gray-800">êµ¬ë¦¬ì—­ ì¶œë°œ</span>
                </div>
                <span class="text-4xl">ğŸ </span>
            </button>

            <button onclick="openSearch('in')" class="big-button w-full bg-white border-2 border-green-500 rounded-2xl p-5 text-left flex items-center justify-between shadow-sm">
                <div>
                    <span class="text-gray-500 text-sm block mb-1 font-bold">ì§‘ì— ì˜¬ ë•Œ</span>
                    <span class="text-xl font-black text-gray-800">êµ¬ë¦¬ì—­ ë„ì°©</span>
                </div>
                <span class="text-4xl">ğŸš‰</span>
            </button>

            <button onclick="toggleMap(true)" class="big-button w-full bg-orange-400 border-2 border-orange-500 rounded-2xl p-3 text-center">
                <span class="text-lg font-black text-white">ğŸ—ºï¸ ë…¸ì„ ë„ í¬ê²Œ ë³´ê¸°</span>
            </button>

            <div id="favorites-section" class="hidden mt-6">
                <h2 class="text-lg font-black text-gray-700 mb-3 ml-1">â­ ìì£¼ ê°€ëŠ” ê³³</h2>
                <div id="favorites-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- ê²€ìƒ‰ì°½ -->
        <div id="search-view" class="hidden fixed inset-0 bg-white z-[60] p-6 flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-black text-blue-800">ì—­ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</h2>
                <button onclick="closeSearch()" class="text-3xl font-bold p-2 text-gray-400">âœ•</button>
            </div>
            
            <input type="text" id="station-input" oninput="filterStations(this.value)" autofocus
                   placeholder="ì˜ˆ: ì„œìš¸ì—­, ê°•ë‚¨, ì ì‹¤" 
                   class="w-full border-b-4 border-blue-500 p-2 font-black focus:outline-none placeholder-gray-300">
            
            <div id="search-results" class="flex-1 overflow-y-auto space-y-3 mt-4 pb-6"></div>
        </div>

        <!-- ê²½ë¡œ ì•ˆë‚´íŒ -->
        <div id="route-detail" class="hidden bg-white rounded-3xl border-2 border-blue-200 p-5 shadow-xl space-y-5">
            <div class="flex justify-between items-center">
                <button onclick="goHome()" class="bg-gray-400 text-white px-3 py-1.5 rounded-xl text-sm font-bold">ì²˜ìŒìœ¼ë¡œ</button>
                <button id="fav-btn" onclick="toggleFavorite()" class="text-4xl">â˜†</button>
            </div>
            
            <div id="route-path-summary" class="flex flex-wrap items-center justify-center gap-1 p-3 bg-gray-50 rounded-xl border border-gray-100 font-bold"></div>

            <div id="route-content" class="space-y-2"></div>

            <button onclick="toggleMap(true)" class="block w-full bg-orange-500 text-white text-center py-4 rounded-xl text-lg font-black shadow-lg">
                ğŸ—ºï¸ ì§€ë„ì—ì„œ í™•ì¸
            </button>
        </div>

        <!-- ë¡œë”© -->
        <div id="loading" class="hidden fixed inset-0 bg-black/40 z-[100] flex items-center justify-center">
            <div class="bg-white p-6 rounded-3xl text-center shadow-2xl">
                <div class="inline-block w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"></div>
                <p class="text-lg font-bold text-gray-800">ê¸¸ì„ ì°¾ê³  ìˆì–´ìš”...</p>
            </div>
        </div>
    </main>

    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="message-box" class="bg-white p-6 rounded-3xl border-4 border-red-400 shadow-2xl text-center">
        <p id="message-text" class="text-lg font-bold text-gray-800 mb-4"></p>
        <button onclick="hideMessage()" class="bg-gray-500 text-white px-6 py-2 rounded-xl font-bold">í™•ì¸</button>
    </div>

    <!-- ì§€ë„ ëª¨ë‹¬ -->
    <div id="map-modal">
        <div class="min-h-screen flex flex-col p-4">
            <button onclick="toggleMap(false)" class="sticky top-4 self-end bg-white border-2 border-black text-black px-6 py-2 rounded-full text-xl font-bold shadow-2xl z-[110]">ë‹«ê¸° âœ•</button>
            <div class="overflow-auto mt-4 flex-1 rounded-2xl bg-white">
                <img src="map_korea.jpg" alt="ë…¸ì„ ë„" class="max-w-none w-[400%]" id="map-img">
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // API í‚¤ (ì´ë™ ì¤‘ì´ê±°ë‚˜ Vercel ì‚¬ìš© ì‹œ ì„¤ì • í•„ìš”)
        let currentTarget = null;
        let searchMode = 'out';
        
        let favorites = JSON.parse(localStorage.getItem('guri_mama_v14') || '[]');
        let routeCache = JSON.parse(localStorage.getItem('guri_route_cache_v14') || '{}');

        // [ì†ë„ ê°œì„ ] API ì—†ì´ë„ ì¦‰ì‹œ ì‘ë™í•˜ëŠ” ì£¼ìš” ì—­ ë°ì´í„°
        const localData = {
            "ì ì‹¤ì—­": { path: ["êµ¬ë¦¬ì—­", "ì ì‹¤ì—­"], steps: [{type:"ride", station:"êµ¬ë¦¬ì—­", line:"8", color:"line-8", msg:"8í˜¸ì„ (ëª¨ë€í–‰) íƒ€ì„¸ìš”."}, {type:"arrive", station:"ì ì‹¤ì—­", msg:"ë„ì°©í–ˆìŠµë‹ˆë‹¤. ë‚´ë¦¬ì„¸ìš”."}] },
            "ì„œìš¸ì—­": { path: ["êµ¬ë¦¬ì—­", "íšŒê¸°ì—­", "ì„œìš¸ì—­"], steps: [{type:"ride", station:"êµ¬ë¦¬ì—­", line:"ê²½ì˜ì¤‘ì•™", color:"line-gj", msg:"ê²½ì˜ì¤‘ì•™ì„ (ë¬¸ì‚°í–‰) íƒ€ì„¸ìš”."}, {type:"transfer", station:"íšŒê¸°ì—­", line:"1", color:"line-1", pos:"1-1ë²ˆ", msg:"ë‚´ë ¤ì„œ 1í˜¸ì„ (ì¸ì²œí–‰)ìœ¼ë¡œ ê°ˆì•„íƒ€ì„¸ìš”."}, {type:"arrive", station:"ì„œìš¸ì—­", msg:"ë„ì°©í–ˆìŠµë‹ˆë‹¤. ë‚´ë¦¬ì„¸ìš”."}] },
            "ê°•ë‚¨ì—­": { path: ["êµ¬ë¦¬ì—­", "ì ì‹¤ì—­", "ê°•ë‚¨ì—­"], steps: [{type:"ride", station:"êµ¬ë¦¬ì—­", line:"8", color:"line-8", msg:"8í˜¸ì„ (ëª¨ë€í–‰) íƒ€ì„¸ìš”."}, {type:"transfer", station:"ì ì‹¤ì—­", line:"2", color:"line-2", pos:"3-1ë²ˆ", msg:"ë‚´ë ¤ì„œ 2í˜¸ì„ (êµëŒ€ë°©í–¥)ìœ¼ë¡œ ê°ˆì•„íƒ€ì„¸ìš”."}, {type:"arrive", station:"ê°•ë‚¨ì—­", msg:"ë„ì°©í–ˆìŠµë‹ˆë‹¤. ë‚´ë¦¬ì„¸ìš”."}] },
            "ì²œí˜¸ì—­": { path: ["êµ¬ë¦¬ì—­", "ì²œí˜¸ì—­"], steps: [{type:"ride", station:"êµ¬ë¦¬ì—­", line:"8", color:"line-8", msg:"8í˜¸ì„ (ëª¨ë€í–‰) íƒ€ì„¸ìš”."}, {type:"arrive", station:"ì²œí˜¸ì—­", msg:"ë„ì°©í–ˆìŠµë‹ˆë‹¤. ë‚´ë¦¬ì„¸ìš”."}] }
        };

        function formatStationName(name) {
            if (!name) return "";
            let clean = name.trim().replace(/ì—­+$/, '');
            return clean + 'ì—­';
        }

        function showMessage(text) {
            document.getElementById('message-text').innerText = text;
            document.getElementById('message-box').style.display = 'block';
        }

        function hideMessage() {
            document.getElementById('message-box').style.display = 'none';
        }

        function openSearch(mode) {
            searchMode = mode;
            document.getElementById('search-view').classList.remove('hidden');
            document.getElementById('station-input').value = '';
            document.getElementById('station-input').focus();
            filterStations('');
        }

        function closeSearch() {
            document.getElementById('search-view').classList.add('hidden');
        }

        function filterStations(query) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';
            
            const quickList = ["ì ì‹¤ì—­", "ì„œìš¸ì—­", "ê°•ë‚¨ì—­", "ì²œí˜¸ì—­", "ë‹¤ì‚°ì—­", "ë³„ë‚´ì—­", "ì™•ì‹­ë¦¬ì—­", "ì²­ëŸ‰ë¦¬ì—­", "ëª…ë™ì—­", "ì¸ì²œì—­", "ìˆ˜ì›ì—­", "ë™íƒ„ì—­"];
            
            if (query.length > 0) {
                const btn = document.createElement('button');
                btn.className = "w-full bg-blue-50 border-2 border-blue-200 p-4 rounded-xl text-left shadow-sm flex justify-between items-center mb-4";
                btn.onclick = () => findRoute(query);
                btn.innerHTML = `<span class="text-lg font-bold text-blue-900">'${formatStationName(query)}' ì°¾ê¸°</span> <span class="text-xl">ğŸ”</span>`;
                container.appendChild(btn);
            }

            quickList.filter(s => s.includes(query)).forEach(name => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-white border-2 border-gray-100 p-4 rounded-xl text-left shadow-sm mb-2";
                btn.onclick = () => findRoute(name);
                btn.innerHTML = `<span class="text-lg font-bold text-gray-800">${name}</span>`;
                container.appendChild(btn);
            });
        }

        async function fetchRouteWithRetry(start, end, maxRetries = 5) {
            const delays = [1000, 2000, 4000, 8000, 16000];
            const systemPrompt = `ì§€í•˜ì²  ê²½ë¡œ ì•ˆë‚´ ì „ë¬¸ê°€. 80ëŒ€ ì–´ë¨¸ë‹ˆë¥¼ ìœ„í•´ ì•„ì£¼ ì‰½ê³  ê°„ê²°í•˜ê²Œ ë‹µí•¨.
            ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ:
            {
                "path": ["ì¶œë°œì—­", "í™˜ìŠ¹ì—­", "ë„ì°©ì—­"],
                "steps": [
                    {"type": "ride", "station": "ì¶œë°œì—­", "line": "8", "color": "line-8", "msg": "8í˜¸ì„ (ëª¨ë€í–‰) íƒ€ì„¸ìš”."},
                    {"type": "transfer", "station": "í™˜ìŠ¹ì—­", "line": "2", "color": "line-2", "pos": "3-1ë²ˆ", "msg": "ë‚´ë ¤ì„œ 2í˜¸ì„ (êµëŒ€ë°©í–¥)ìœ¼ë¡œ ê°ˆì•„íƒ€ì„¸ìš”."},
                    {"type": "arrive", "station": "ë„ì°©ì—­", "msg": "ë„ì°©í–ˆìŠµë‹ˆë‹¤. ë‚´ë¦¬ì„¸ìš”."}
                ]
            }`;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `${start}ì—ì„œ ${end}ê¹Œì§€ ê°€ëŠ” ë²• ì•Œë ¤ì¤˜` }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) throw new Error("API ì—°ê²° ì‹¤íŒ¨");

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨");
                    
                    return JSON.parse(jsonMatch[0]);
                } catch (err) {
                    if (i === maxRetries - 1) throw err;
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        async function findRoute(targetStation) {
            const formattedTarget = formatStationName(targetStation);
            const cacheKey = `${searchMode}_${formattedTarget}`;
            
            // 1. ìºì‹œ í™•ì¸ (ì†ë„ 1ìˆœìœ„)
            if (routeCache[cacheKey]) {
                closeSearch();
                renderRoute(routeCache[cacheKey], targetStation);
                return;
            }

            // 2. ë¡œì»¬ ë°ì´í„° í™•ì¸ (ì†ë„ 2ìˆœìœ„)
            if (searchMode === 'out' && localData[formattedTarget]) {
                closeSearch();
                renderRoute(localData[formattedTarget], targetStation);
                return;
            }

            closeSearch();
            document.getElementById('loading').classList.remove('hidden');
            
            const start = searchMode === 'out' ? 'êµ¬ë¦¬ì—­' : formattedTarget;
            const end = searchMode === 'out' ? formattedTarget : 'êµ¬ë¦¬ì—­';

            try {
                const route = await fetchRouteWithRetry(start, end);
                routeCache[cacheKey] = route;
                localStorage.setItem('guri_route_cache_v14', JSON.stringify(routeCache));
                renderRoute(route, targetStation);
            } catch (error) {
                console.error("ì˜¤ë¥˜:", error);
                showMessage("ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì‹œê±°ë‚˜ ì§€ë„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderRoute(route, originalTarget) {
            currentTarget = { name: originalTarget, data: route };
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('route-detail').classList.remove('hidden');

            const summary = document.getElementById('route-path-summary');
            summary.innerHTML = route.path.map((p, idx) => `
                <span class="text-xs font-bold ${idx === route.path.length-1 ? 'text-green-600' : 'text-gray-800'}">${formatStationName(p)}</span>
                ${idx < route.path.length - 1 ? '<span class="text-xs text-gray-300 mx-1">âœ</span>' : ''}
            `).join('');

            const content = document.getElementById('route-content');
            content.innerHTML = route.steps.map((step, idx) => {
                let msgHtml = step.msg;
                if (step.type === 'transfer') {
                    msgHtml = msgHtml.replace("ë‚´ë ¤ì„œ", "<span class='highlight-action'>ë‚´ë ¤ì„œ</span>").replace("ê°ˆì•„íƒ€ì„¸ìš”", "<span class='highlight-action'>ê°ˆì•„íƒ€ì„¸ìš”</span>");
                } else if (step.type === 'arrive' || step.msg.includes("ë‚´ë¦¬ì„¸ìš”")) {
                    msgHtml = msgHtml.replace("ë‚´ë¦¬ì„¸ìš”", "<span class='highlight-action'>ë‚´ë¦¬ì„¸ìš”</span>").replace("ë‚´ë¦¬ì‹œë©´", "<span class='highlight-action'>ë‚´ë¦¬ì‹œë©´</span>");
                }

                return `
                <div class="path-step">
                    <div class="circle-num">${idx + 1}</div>
                    <div class="space-y-1">
                        <div class="flex items-center">
                            <span class="line-badge ${step.color || 'line-default'}">${step.line || ''}</span>
                            <span class="text-base font-black text-gray-800">${formatStationName(step.station)}</span>
                        </div>
                        <p class="action-text">${msgHtml}</p>
                        ${step.pos ? `<div class="inline-block mt-1 bg-green-50 px-2 py-0.5 rounded-lg border border-green-200"><p class="text-xs font-bold text-green-800">ğŸ’¡ ë¹¨ë¦¬ ê°ˆì•„íƒ€ëŠ” ì¹¸: <span class="text-red-600 underline">${step.pos}</span></p></div>` : ''}
                    </div>
                </div>`;
            }).join('');

            updateFavoriteStar();
        }

        function toggleFavorite() {
            const index = favorites.findIndex(f => f.name === currentTarget.name);
            if (index > -1) favorites.splice(index, 1);
            else favorites.push(currentTarget);
            localStorage.setItem('guri_mama_v14', JSON.stringify(favorites));
            updateFavoriteStar();
        }

        function updateFavoriteStar() {
            const isFav = favorites.some(f => f.name === currentTarget.name);
            document.getElementById('fav-btn').innerText = isFav ? 'â­' : 'â˜†';
            document.getElementById('fav-btn').style.color = isFav ? '#f59e0b' : '#9ca3af';
        }

        function renderFavorites() {
            const container = document.getElementById('favorites-list');
            const section = document.getElementById('favorites-section');
            if (favorites.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            container.innerHTML = '';
            favorites.forEach(fav => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-yellow-50 border-2 border-yellow-200 rounded-2xl p-4 flex items-center justify-between shadow-sm";
                btn.onclick = () => renderRoute(fav.data, fav.name);
                btn.innerHTML = `<span class="text-base font-bold text-gray-800">ğŸ  â†’ ${formatStationName(fav.name)}</span> <span class="text-xl">â¡ï¸</span>`;
                container.appendChild(btn);
            });
        }

        function goHome() {
            document.getElementById('route-detail').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            renderFavorites();
        }

        function toggleMap(show) { document.getElementById('map-modal').style.display = show ? 'block' : 'none'; }
        window.onload = renderFavorites;
    </script>
</body>
</html>
